<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LSE Academic Tracker Pro</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&family=Playfair+Display:ital,wght@0,600;0,700;1,600&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #ff4757; 
            --bg-deep: #090910;
            --card-glass: rgba(255, 255, 255, 0.05);
            --border-light: rgba(255, 255, 255, 0.1);
            --text-main: #ffffff;
            --text-sub: #a0a0a0;
            
            --distinction: #2ed573;
            --merit: #1e90ff;
            --pass: #ffa502;
            --fail: #ff4757;
            --waiting: #00d2d3; /* Cyan for waiting results */
            --urgent: #ff6b6b;
        }

        body {
            font-family: 'Noto Sans SC', sans-serif;
            background-color: var(--bg-deep);
            background-image: radial-gradient(circle at 50% 0%, #1a1a2e 0%, #090910 80%);
            color: var(--text-main);
            margin: 0; padding: 0; min-height: 100vh;
            overflow-x: hidden;
        }

        /* åŠ¨æ€æ˜Ÿç©º */
        #stars { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; pointer-events: none; }
        .star { position: absolute; background: white; border-radius: 50%; opacity: 0; animation: twinkle ease-in-out infinite; }
        @keyframes twinkle { 0% { opacity: 0; } 50% { opacity: 0.8; } 100% { opacity: 0; } }

        /* ç™»å½•å±‚ */
        #login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(9, 9, 16, 0.95); backdrop-filter: blur(20px);
            z-index: 1000; display: flex; justify-content: center; align-items: center;
        }
        .login-box {
            background: rgba(255,255,255,0.05); padding: 50px; border-radius: 20px;
            border: 1px solid var(--border-light); text-align: center; width: 350px;
        }
        .login-input {
            width: 100%; padding: 15px; margin: 10px 0; background: rgba(0,0,0,0.3);
            border: 1px solid var(--border-light); color: white; border-radius: 8px;
            font-size: 1rem; box-sizing: border-box; outline: none;
        }
        .btn-login {
            width: 100%; padding: 15px; background: linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%);
            color: #000; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 20px; font-size: 1rem;
        }

        /* ä¸»ç•Œé¢ */
        .app-container { display: none; padding: 40px; max-width: 1600px; margin: 0 auto; }
        .app-container.active { display: block; }

        header { display: grid; grid-template-columns: 1fr 1fr; gap: 40px; margin-bottom: 50px; align-items: start; }
        
        .header-left h1 { font-family: 'Playfair Display', serif; font-size: 2.5rem; margin: 0; background: linear-gradient(90deg, #fff, #b3cdd1); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .user-badge { display: inline-block; background: rgba(255,255,255,0.1); padding: 5px 15px; border-radius: 20px; font-size: 0.8rem; margin-top: 10px; color: var(--text-sub); cursor: pointer; }
        
        /* æ™ºèƒ½å¤‡å¿˜å½• */
        .notepad-panel {
            background: rgba(0, 0, 0, 0.3); border: 1px solid var(--border-light);
            border-radius: 16px; padding: 20px; min-height: 120px; display: flex; flex-direction: column;
        }
        .notepad-list { flex-grow: 1; display: flex; flex-direction: column; gap: 8px; max-height: 160px; overflow-y: auto; }
        .todo-item { display: flex; align-items: center; gap: 10px; font-size: 0.9rem; padding: 10px; background: rgba(255,255,255,0.03); border-radius: 8px; }
        
        .days-tag { padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; min-width: 80px; text-align: center; }
        .days-tag.urgent { background: rgba(255, 107, 107, 0.2); color: var(--urgent); border: 1px solid var(--urgent); }
        .days-tag.waiting { background: rgba(0, 210, 211, 0.2); color: var(--waiting); border: 1px solid var(--waiting); }
        .days-tag.normal { background: rgba(30, 144, 255, 0.2); color: var(--merit); border: 1px solid var(--merit); }

        /* å…¨å±€ç»Ÿè®¡ */
        .stats-row { display: flex; gap: 40px; margin-bottom: 40px; padding-bottom: 20px; border-bottom: 1px solid var(--border-light); margin-top: 30px;}
        .stat-box .label { font-size: 0.8rem; color: var(--text-sub); margin-bottom: 5px; }
        .stat-box .val { font-family: 'Playfair Display', serif; font-size: 2.2rem; font-weight: 700; }
        .goal-inp { background: transparent; border: none; border-bottom: 1px solid #666; color: white; font-size: 2.2rem; width: 70px; font-family: 'Playfair Display'; text-align: center;}

        /* Grid & Card */
        .controls { text-align: right; margin-bottom: 20px; }
        .btn-add { background: white; color: black; border: none; padding: 10px 25px; border-radius: 25px; cursor: pointer; font-weight: 600; transition: 0.2s; }
        .btn-add:hover { transform: scale(1.05); }

        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 30px; }
        .card {
            background: var(--card-glass); border: 1px solid var(--border-light); border-radius: 24px;
            padding: 30px; cursor: pointer; height: 260px; display: flex; flex-direction: column; justify-content: space-between;
            position: relative; overflow: hidden; transition: all 0.3s;
        }
        .card:hover { background: rgba(255,255,255,0.08); transform: translateY(-5px); }

        /* æ¶²ä½“çƒ */
        .orb {
            width: 100px; height: 100px; border-radius: 50%; border: 3px solid rgba(255,255,255,0.1);
            position: relative; overflow: hidden; background: rgba(0,0,0,0.2); margin: 0 auto;
            box-shadow: 0 0 20px rgba(0,0,0,0.5) inset;
        }
        .orb-wave {
            position: absolute; width: 200%; height: 200%; background: var(--merit);
            border-radius: 40%; opacity: 0.8; animation: spin 6s infinite linear;
            bottom: 0; left: -50%; transform: translateY(100%); transition: transform 0.6s, background 0.6s;
        }
        .orb-text {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; justify-content: center; align-items: center;
            font-size: 1.5rem; font-weight: bold; z-index: 2; text-shadow: 0 2px 5px rgba(0,0,0,0.8);
        }
        @keyframes spin { from { transform: translateY(var(--level)) rotate(0deg); } to { transform: translateY(var(--level)) rotate(360deg); } }

        /* Modal */
        .modal-bg {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); backdrop-filter: blur(15px);
            z-index: 200; display: none; opacity: 0; transition: opacity 0.3s;
        }
        .modal-bg.open { display: flex; opacity: 1; justify-content: center; align-items: center; }
        
        .modal-body {
            width: 90%; max-width: 1200px; height: 85vh;
            background: #141419; border: 1px solid var(--border-light);
            border-radius: 24px; padding: 40px; display: grid;
            grid-template-columns: 1.2fr 0.8fr; gap: 40px; overflow: hidden;
            box-shadow: 0 50px 100px rgba(0,0,0,0.8);
        }

        .modal-left { display: flex; flex-direction: column; height: 100%; }
        .modal-right { background: rgba(255,255,255,0.03); border-radius: 20px; padding: 25px; overflow-y: auto; }

        .modal-title-inp { background: transparent; border: none; border-bottom: 2px solid #333; color: white; font-family: 'Playfair Display'; font-size: 2.2rem; width: 100%; margin-bottom: 20px; outline: none; }
        
        .assign-header, .assign-row {
            display: grid; grid-template-columns: 2fr 0.8fr 0.8fr 1.2fr 30px; gap: 15px;
            font-size: 0.9rem; color: var(--text-sub); align-items: center;
        }
        .assign-header { margin-bottom: 15px; padding: 0 10px; }
        .assign-list { overflow-y: auto; flex-grow: 1; padding-right: 10px; margin-bottom: 20px; }
        .assign-row { margin-bottom: 12px; }

        .inp { background: rgba(255,255,255,0.05); border: 1px solid #333; color: white; padding: 12px; border-radius: 8px; font-size: 1rem; width: 100%; box-sizing: border-box; }
        .inp:focus { border-color: var(--text-sub); outline: none; background: rgba(255,255,255,0.08); }
        input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(0.8); cursor: pointer; }

        .btn-row-add { width: 100%; padding: 15px; border: 1px dashed #555; background: transparent; color: #888; border-radius: 10px; cursor: pointer; }
        .btn-row-add:hover { border-color: white; color: white; }
        .btn-close { position: absolute; top: 20px; right: 20px; font-size: 2rem; background: none; border: none; color: #666; cursor: pointer; }

        .analysis-block { margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .analysis-main-score { font-size: 2.5rem; font-family: 'Playfair Display'; font-weight: bold; margin-bottom: 5px; }
        .tag { padding: 3px 8px; font-size: 0.75rem; border-radius: 4px; border: 1px solid currentColor; display: inline-block; margin-right: 5px;}

        @media (max-width: 1000px) {
            header { grid-template-columns: 1fr; }
            .modal-body { grid-template-columns: 1fr; height: auto; min-height: 90vh; }
            .modal-right { display: none; }
            .assign-header, .assign-row { grid-template-columns: 1.5fr 0.8fr 0.8fr 30px; }
            .assign-row input[type="date"] { display: none; }
            .assign-header span:nth-child(4) { display: none; }
        }
    </style>
</head>
<body>

<div id="stars"></div>

<!-- Login -->
<div id="login-overlay">
    <div class="login-box">
        <h2 style="font-family:'Playfair Display'; margin-bottom: 5px;">LSE Portal</h2>
        <p style="color:var(--text-sub); font-size:0.8rem; margin-bottom:30px;">å­¦æœ¯æ¡£æ¡ˆç³»ç»Ÿ v3.1</p>
        <input type="text" id="login-major" class="login-input" placeholder="ä¸“ä¸š (Major)">
        <input type="text" id="login-name" class="login-input" placeholder="å§“å (Name)">
        <button class="btn-login" onclick="handleLogin()">ç™»å½• / æ³¨å†Œ</button>
    </div>
</div>

<!-- Main App -->
<div class="app-container" id="app">
    <header>
        <div class="header-left">
            <h1>Academic Performance</h1>
            <div class="user-badge" id="display-user" onclick="logout()">--</div>
            
            <div class="stats-row">
                <div class="stat-box">
                    <div class="label">Banked Avg (Completed)</div>
                    <div class="val" id="global-avg" style="color:var(--merit)">--</div>
                </div>
                <div class="stat-box">
                    <div class="label">Target Goal</div>
                    <div style="display:flex; align-items:flex-end;">
                        <input type="number" id="global-target" class="goal-inp" value="70" onchange="updateAll()">
                        <span style="font-size:1.5rem; margin-bottom:10px;">%</span>
                    </div>
                </div>
                <div class="stat-box">
                    <div class="label">Status</div>
                    <div class="val" id="global-status" style="font-size:1.2rem; line-height:2.2rem; color:#888">--</div>
                </div>
            </div>
        </div>

        <div class="notepad-panel">
            <div style="margin-bottom:10px; font-size:0.9rem; color:#888; display:flex; justify-content:space-between;">
                <span>ğŸ“ æ™ºèƒ½å¤‡å¿˜å½• (Timeline)</span>
                <span id="date-today"></span>
            </div>
            <div class="notepad-list" id="notepad-list"></div>
        </div>
    </header>

    <div class="controls">
        <button class="btn-add" onclick="addCourse()">+ æ–°å»ºè¯¾ç¨‹</button>
    </div>

    <div class="grid" id="course-grid"></div>
</div>

<!-- Modal -->
<div class="modal-bg" id="modal">
    <div class="modal-body">
        <button class="btn-close" onclick="closeModal()">&times;</button>
        
        <div class="modal-left">
            <input type="text" class="modal-title-inp" id="m-name" placeholder="è¯¾ç¨‹åç§° (å¦‚ EC102)" oninput="saveAndRenderTitle()">
            
            <div class="assign-header">
                <span>ä½œä¸šåç§°</span>
                <span>æƒé‡%</span>
                <span>åˆ†æ•°</span>
                <span>DDL (é€‰å¡«)</span>
                <span></span>
            </div>
            
            <div class="assign-list" id="m-list"></div>
            
            <button class="btn-row-add" onclick="addAssignRow()">+ æ·»åŠ ä½œä¸š</button>
            <div style="margin-top:auto; padding-top:20px;">
                <span style="color:var(--fail); cursor:pointer; font-size:0.9rem;" onclick="deleteCourse()">æ°¸ä¹…åˆ é™¤æ­¤è¯¾ç¨‹</span>
            </div>
        </div>

        <div class="modal-right">
            <h3 style="font-family:'Playfair Display'; margin-top:0;">æˆç»©è¶‹åŠ¿</h3>
            <div id="chart-container" style="height:250px; width:100%; background:rgba(0,0,0,0.2); border-radius:12px; margin-bottom:20px;"></div>
            
            <h3 style="font-family:'Playfair Display';">æ·±åº¦åˆ†æ</h3>
            <div id="analysis-content" style="font-size:1rem; line-height:1.6; color:#ddd;"></div>
        </div>
    </div>
</div>

<script>
    let DATA = { courses: [] };
    let CURRENT_USER_KEY = null;
    let CURRENT_COURSE_ID = null;
    const COLORS = { D: '#2ed573', M: '#1e90ff', P: '#ffa502', F: '#ff4757', Zero: '#a29bfe' };

    // --- System ---
    function handleLogin() {
        const major = document.getElementById('login-major').value.trim();
        const name = document.getElementById('login-name').value.trim();
        if (!major || !name) { alert("è¯·è¾“å…¥å®Œæ•´ä¿¡æ¯"); return; }
        
        CURRENT_USER_KEY = `LSE_V3_${major}_${name}`;
        loadData();
        
        document.getElementById('login-overlay').style.display = 'none';
        document.getElementById('app').classList.add('active');
        document.getElementById('display-user').textContent = `${major} | ${name}`;
        document.getElementById('date-today').textContent = new Date().toLocaleDateString('zh-CN');
        
        renderGrid();
        updateAll();
    }
    function loadData() {
        const stored = localStorage.getItem(CURRENT_USER_KEY);
        DATA = stored ? JSON.parse(stored) : { courses: [] };
    }
    function saveData() {
        if (CURRENT_USER_KEY) localStorage.setItem(CURRENT_USER_KEY, JSON.stringify(DATA));
        renderNotepad();
    }
    function logout() { if(confirm("é€€å‡ºç™»å½•ï¼Ÿ")) location.reload(); }

    // --- Logic ---
    function addCourse() {
        const newId = 'c_' + Date.now();
        DATA.courses.push({
            id: newId, name: '', 
            assignments: [{ name: 'Exam/Essay', w: 100, g: '', ddl: '' }] 
        });
        saveData();
        renderGrid();
        openModal(newId);
    }
    
    function deleteCourse() {
        if (confirm("ç¡®è®¤åˆ é™¤ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚")) {
            DATA.courses = DATA.courses.filter(c => c.id !== CURRENT_COURSE_ID);
            saveData();
            closeModal();
            renderGrid();
            updateAll();
        }
    }

    function calcStats(c) {
        let earned = 0, compW = 0;
        c.assignments.forEach(a => {
            const w = parseFloat(a.w) || 0;
            const g = parseFloat(a.g);
            if (!isNaN(g) && a.g !== '') {
                earned += (g * w / 100);
                compW += w;
            }
        });
        const avg = compW > 0 ? (earned / compW * 100) : 0;
        return { banked: earned, compW, avg, remainingW: 100 - compW };
    }

    // --- Rendering ---
    function renderGrid() {
        const el = document.getElementById('course-grid');
        el.innerHTML = '';
        DATA.courses.forEach(c => {
            const s = calcStats(c);
            const level = 100 - s.banked; // æ°´ä½ï¼šbankedè¶Šé«˜ï¼Œlevelè¶Šå°(ä¸Šç§»)ï¼Œæ˜¾ç¤ºè¶Šå¤šæ°´
            const color = getColor(s.avg);
            
            const div = document.createElement('div');
            div.className = 'card';
            div.onclick = () => openModal(c.id);
            div.innerHTML = `
                <div><h2>${c.name || 'Untitled Course'}</h2></div>
                <div class="orb"><div class="orb-wave" style="--level:${level}%; background:${color}"></div><div class="orb-text">${s.banked.toFixed(0)}</div></div>
                <div style="display:flex; justify-content:space-between; color:#888; font-size:0.9rem;">
                    <span>Done: ${s.compW}%</span>
                    <span>Avg: <strong style="color:${color}">${s.avg.toFixed(1)}</strong></span>
                </div>
            `;
            el.appendChild(div);
        });
        renderNotepad();
    }

    function renderNotepad() {
        const list = document.getElementById('notepad-list');
        list.innerHTML = '';
        const tasks = [];
        const today = new Date(); today.setHours(0,0,0,0);

        DATA.courses.forEach(c => {
            c.assignments.forEach(a => {
                if ((a.g === '' || a.g === null) && a.ddl) {
                    const d = new Date(a.ddl);
                    const diff = Math.ceil((d - today) / (1000 * 60 * 60 * 24));
                    tasks.push({ cName: c.name||'Untitled', aName: a.name, days: diff });
                }
            });
        });

        tasks.sort((a,b) => a.days - b.days);

        if(tasks.length === 0) {
            list.innerHTML = `<div style="text-align:center; padding:20px; color:#555">æ— å¾…åŠäº‹é¡¹</div>`;
            return;
        }

        tasks.forEach(t => {
            let cls = 'normal', txt = `è¿˜æœ‰ ${t.days} å¤©`;
            // é€¾æœŸé€»è¾‘ä¿®å¤ï¼šå¦‚æœé€¾æœŸä¸”æ²¡åˆ†ï¼Œæ˜¾ç¤ºç­‰å¾…å‡ºåˆ†
            if (t.days < 0) { cls = 'waiting'; txt = 'ç­‰å¾…å‡ºåˆ†'; }
            else if (t.days === 0) { cls = 'urgent'; txt = 'ä»Šæ—¥æˆªæ­¢'; }
            else if (t.days <= 3) { cls = 'urgent'; }

            const row = document.createElement('div');
            row.className = 'todo-item';
            row.innerHTML = `<div class="days-tag ${cls}">${txt}</div> <div>${t.aName} <span style="color:#666">- ${t.cName}</span></div>`;
            list.appendChild(row);
        });
    }

    // --- Modal Logic ---
    function openModal(cid) {
        CURRENT_COURSE_ID = cid;
        const c = DATA.courses.find(x => x.id === cid);
        document.getElementById('m-name').value = c.name;
        renderAssignList(c);
        updateAnalysis(c);
        
        const modal = document.getElementById('modal');
        modal.classList.add('open');
        setTimeout(() => drawChart(c), 100);
    }

    function closeModal() {
        document.getElementById('modal').classList.remove('open');
        CURRENT_COURSE_ID = null;
        updateAll();
    }

    function renderAssignList(c) {
        const list = document.getElementById('m-list');
        list.innerHTML = '';
        c.assignments.forEach((a, i) => {
            const div = document.createElement('div');
            div.className = 'assign-row';
            div.innerHTML = `
                <input class="inp" value="${a.name}" placeholder="Name" oninput="upd(${i},'name',this.value)">
                <input type="number" class="inp" value="${a.w}" placeholder="Weight" oninput="upd(${i},'w',this.value)">
                <input type="number" class="inp" value="${a.g}" placeholder="Grade" oninput="upd(${i},'g',this.value)">
                <input type="date" class="inp" value="${a.ddl}" placeholder="Optional" oninput="upd(${i},'ddl',this.value)">
                <div style="text-align:center; cursor:pointer;" onclick="delAss(${i})">&times;</div>
            `;
            list.appendChild(div);
        });
    }

    function addAssignRow() {
        const c = DATA.courses.find(x => x.id === CURRENT_COURSE_ID);
        c.assignments.push({ name: '', w: '', g: '', ddl: '' });
        saveData(); renderAssignList(c);
    }
    
    function delAss(i) {
        const c = DATA.courses.find(x => x.id === CURRENT_COURSE_ID);
        c.assignments.splice(i, 1);
        saveData(); renderAssignList(c); updateAnalysis(c);
        setTimeout(()=>drawChart(c), 50);
        renderGrid(); // Refresh main grid
    }

    function upd(i, field, val) {
        const c = DATA.courses.find(x => x.id === CURRENT_COURSE_ID);
        c.assignments[i][field] = val;
        saveData(); 
        if(field !== 'name') { 
            updateAnalysis(c); 
            setTimeout(()=>drawChart(c), 50); 
            renderGrid(); // å…³é”®ä¿®å¤ï¼šè¾“å…¥åˆ†æ•°æ—¶ç«‹åˆ»åˆ·æ–°ä¸»é¡µæ°´çƒ
        }
    }
    
    function saveAndRenderTitle() {
        const c = DATA.courses.find(x => x.id === CURRENT_COURSE_ID);
        c.name = document.getElementById('m-name').value;
        saveData(); renderGrid();
    }

    // --- Enhanced Analysis ---
    function updateAnalysis(c) {
        const s = calcStats(c);
        const div = document.getElementById('analysis-content');
        const color = getColor(s.avg);
        
        let html = `
            <div class="analysis-block">
                <div style="color:var(--text-sub); font-size:0.9rem;">å½“å‰ä½œä¸šåŠ æƒå‡åˆ†</div>
                <div class="analysis-main-score" style="color:${color}">${s.avg.toFixed(1)}%</div>
                <div style="font-size:0.9rem">
                    <span class="tag" style="color:${COLORS.P}">æƒé‡è¿›åº¦: ${s.compW}%</span>
                    <span class="tag" style="color:${COLORS.D}">å·²è·æ€»åˆ†: ${s.banked.toFixed(1)}</span>
                </div>
            </div>
        `;

        if (s.remainingW <= 0) {
            html += `<div style="color:${color}; font-weight:bold;">ğŸ‰ è¯¾ç¨‹å·²ç»“ç®—<br>æœ€ç»ˆå¾—åˆ†: ${s.banked.toFixed(1)}%</div>`;
        } else {
            const getReq = (t) => {
                const req = (t - s.banked) / (s.remainingW / 100);
                if(req > 100) return `<span style="color:var(--fail)">æ•°å­¦ä¸Šä¸å¯è¡Œ (>100%)</span>`;
                if(req <= 0) return `<span style="color:var(--distinction)">å·²ç¨³æ‹¿ (æ— éœ€åˆ†æ•°)</span>`;
                return `<strong style="color:white; border-bottom:1px solid #555">${req.toFixed(1)}%</strong>`;
            };
            
            html += `<div style="font-size:0.95rem; line-height:2;">
                <div>ä¸ºäº†è¾¾åˆ° <span style="color:var(--distinction)">Distinction (70)</span>ï¼Œå‰©ä½™ä½œä¸šéœ€å‡åˆ†ï¼š${getReq(70)}</div>
                <div>ä¸ºäº†è¾¾åˆ° <span style="color:var(--merit)">Merit (60)</span>ï¼Œå‰©ä½™ä½œä¸šéœ€å‡åˆ†ï¼š${getReq(60)}</div>
                <div>ä¸ºäº†è¾¾åˆ° <span style="color:var(--pass)">Pass (50)</span>ï¼Œå‰©ä½™ä½œä¸šéœ€å‡åˆ†ï¼š${getReq(50)}</div>
                <div style="margin-top:10px; font-size:0.8rem; color:#666;">å‰©ä½™æƒé‡: ${s.remainingW}%</div>
            </div>`;
        }
        div.innerHTML = html;
    }

    // --- Chart ---
    function drawChart(c) {
        const container = document.getElementById('chart-container');
        const pts = c.assignments.filter(a => a.g !== '' && !isNaN(parseFloat(a.g)));
        
        if(pts.length === 0) {
            container.innerHTML = '<div style="height:100%; display:flex; justify-content:center; align-items:center; color:#555">è¾“å…¥æˆç»©åç”Ÿæˆå›¾è¡¨</div>';
            return;
        }

        const w = container.clientWidth || 500;
        const h = container.clientHeight || 250;
        const p = 20;

        const getX = (i) => pts.length === 1 ? w/2 : p + (i / (pts.length - 1)) * (w - 2*p);
        const getY = (val) => h - p - (val / 100) * (h - 2*p);

        let svg = `<svg width="${w}" height="${h}" xmlns="http://www.w3.org/2000/svg">`;
        
        const y70 = getY(70), y60 = getY(60);
        svg += `<line x1="0" y1="${y70}" x2="${w}" y2="${y70}" stroke="${COLORS.D}" stroke-dasharray="4" opacity="0.3"/>`;
        svg += `<line x1="0" y1="${y60}" x2="${w}" y2="${y60}" stroke="${COLORS.M}" stroke-dasharray="4" opacity="0.3"/>`;

        let pathD = "";
        pts.forEach((pt, i) => { pathD += (i===0 ? "M" : "L") + `${getX(i)},${getY(pt.g)} `; });
        if(pts.length > 1) svg += `<path d="${pathD}" fill="none" stroke="white" stroke-width="2" opacity="0.8"/>`;

        pts.forEach((pt, i) => {
            const x = getX(i), y = getY(pt.g);
            svg += `<circle cx="${x}" cy="${y}" r="4" fill="${getColor(pt.g)}" stroke="white" stroke-width="2"/>`;
            svg += `<text x="${x}" y="${y-10}" fill="white" font-size="12" text-anchor="middle">${pt.g}</text>`;
        });
        svg += `</svg>`;
        container.innerHTML = svg;
    }

    // --- Helpers ---
    function updateAll() {
        const target = parseFloat(document.getElementById('global-target').value) || 70;
        let sum = 0, count = 0;
        DATA.courses.forEach(c => {
            const s = calcStats(c);
            if(s.compW >= 99) { sum += s.banked; count++; }
        });
        
        const elAvg = document.getElementById('global-avg');
        const elStat = document.getElementById('global-status');
        
        if(count === 0) {
            elAvg.textContent = "--"; elStat.textContent = "ç­‰å¾…è¯¾ç¨‹å®Œç»“";
        } else {
            const final = sum / count;
            elAvg.textContent = final.toFixed(1) + "%";
            elAvg.style.color = getColor(final);
            elStat.innerHTML = final >= target ? 
                `<span style="color:var(--distinction)">ç›®æ ‡è¾¾æˆ</span>` : 
                `<span style="color:var(--fail)">å·® ${(target-final).toFixed(1)}</span>`;
        }
    }

    function getColor(s) {
        if(s>=70) return COLORS.D; if(s>=60) return COLORS.M; if(s>=50) return COLORS.P; return COLORS.F;
    }

    // Stars
    const sc = document.getElementById('stars');
    for(let i=0; i<100; i++){
        let d=document.createElement('div'); d.className='star';
        d.style.left=Math.random()*100+'%'; d.style.top=Math.random()*100+'%';
        d.style.width=Math.random()*3+'px'; d.style.height=d.style.width;
        d.style.animationDuration=(Math.random()*3+2)+'s'; d.style.animationDelay=Math.random()*5+'s';
        sc.appendChild(d);
    }
</script>
</body>
</html>